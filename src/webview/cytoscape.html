<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src {{cspSource}} 'unsafe-inline'; script-src 'nonce-{{nonce}}' https://unpkg.com; connect-src https:;">
    <title>Cervyn Visualizer</title>
    <link rel="stylesheet" href="{{styleUri}}" nonce="{{nonce}}">
</head>
<body>
    <div class="toolbar">
        <!-- Layout: fCoSE (Fixed) -->
        <!-- Using fCoSE layout exclusively - optimized for hierarchical graphs -->
        
        <!-- Node Search -->
        <div class="toolbar-group search-group">
            <div class="search-container">
                <input 
                    type="text" 
                    id="nodeSearchInput" 
                    class="search-input" 
                    placeholder="Search nodes..." 
                    title="Search for nodes by name, ID, or path"
                    autocomplete="off"
                />
                <button id="clearSearchBtn" class="search-clear-btn" title="Clear search" style="display: none;">âœ•</button>
                <div id="searchResults" class="search-results" style="display: none;"></div>
            </div>
        </div>
        
        <!-- Multi-Layer Selector: Workflow + C4 Model -->
        <div class="toolbar-group">
            <span class="select-label">Layer</span>
            <select id="layerSelect" class="toolbar-select" title="Switch visualization layer">
                <option value="workflow">Workflow</option>
                <option value="context">Context</option>
                <option value="container">Container</option>
                <option value="component">Component</option>
                <option value="code" selected>Code</option>
            </select>
        </div>
        
        <!-- More Options -->
        <div class="toolbar-group">
            <button id="moreOptionsBtn" class="icon-btn" title="More options" aria-label="More options">
                <svg class="icon" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                </svg>
            </button>
            <div id="moreOptionsMenu" class="dropdown-menu">
                <button id="toggleLegendBtn" class="dropdown-item">
                    <span class="dropdown-label">Toggle Legend</span>
                </button>
                <div class="dropdown-divider"></div>
                <button id="showHelpBtn" class="dropdown-item">
                    <span class="dropdown-label">Show Help</span>
                </button>
                <div class="dropdown-divider"></div>
                <button id="refreshGraphBtn" class="dropdown-item">
                    <span class="dropdown-label">Refresh Graph</span>
                </button>
            </div>
        </div>
    </div>
    <div id="cy"></div>
    
    <!-- Bottom Stats -->
    <div class="bottom-stats">
        <span id="zoomLevel" class="stat-item">100%</span>
        <span class="stat-separator">Â·</span>
        <span id="nodeCount" class="stat-item">0 nodes</span>
        <span class="stat-separator">Â·</span>
        <span id="edgeCount" class="stat-item">0 edges</span>
    </div>
    
    <!-- Minimap -->
    <div id="minimap" class="minimap">
        <canvas id="minimapCanvas"></canvas>
    </div>
    
    <!-- Legend Panel -->
    <div id="legendPanel" class="legend-panel" style="display: none;">
        <div class="legend-header">
            <h3 class="legend-title">Legend</h3>
            <button id="legendClose" class="legend-close-btn" title="Close">âœ•</button>
        </div>
        <div class="legend-content" id="legendContent">
            <!-- Dynamically populated -->
        </div>
    </div>
    
    <div class="loading" id="loading">Loading graph...</div>
    <div id="nodeTooltip"></div>
    
    <!-- Feature Tracing Panel -->
    <div id="featureTracingPanel" class="feature-tracing-panel" style="display: none;">
        <div class="panel-header">
            <h3 id="featureTracingTitle">Feature Details</h3>
            <button id="featureTracingClose" class="panel-close-btn">âœ•</button>
        </div>
        <div class="panel-content">
            <div id="featureTracingContent">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>
    
    <!-- Onboarding overlay -->
    <div id="onboardingOverlay" style="display: none;">
        <div id="onboardingCard">
            <div id="onboardingHeader">
                <span id="onboardingTitle">Welcome to Cervyn Visualizer! ğŸ‰</span>
                <button id="onboardingClose" title="Close">âœ•</button>
            </div>
            <div id="onboardingContent">
                <p id="onboardingMessage">
                    <strong id="focusFileLabel"></strong>
                </p>
                <ul id="onboardingTips">
                    <li>ğŸ’¡ <strong>Click nodes</strong> to navigate to files</li>
                    <li>ğŸ” <strong>Search nodes</strong> using the search bar</li>
                    <li>ğŸ“Š <strong>Switch layers</strong> to view different abstraction levels (workflow, context, container, component, code)</li>
                    <li>ğŸ” <strong>Scroll</strong> to zoom in/out</li>
                    <li>ğŸ—ºï¸ <strong>Minimap</strong> shows graph overview - click to navigate</li>
                    <li>ğŸ¨ <strong>Customize colors</strong> via More Options menu</li>
                    <li>ğŸ“– <strong>Toggle Legend</strong> to see node and edge type meanings</li>
                    <li>ğŸ¤– <strong>MCP Integration</strong> - Use AI to manipulate the graph</li>
                </ul>
            </div>
            <div id="onboardingActions">
                <button id="onboardingGotIt">Got it!</button>
                <button id="onboardingTour">Show Full Tour</button>
            </div>
        </div>
    </div>

    <!-- 
        Load external libraries from CDN
        Note: All dynamic configuration (styles, layout config) is sent via postMessage
        This follows VS Code webview best practices for security and maintainability
    -->
    <script nonce="{{nonce}}">
        console.log('[HTML] Cytoscape webview initializing...');
    </script>

    <script nonce="{{nonce}}" src="{{cytoscapeUri}}"></script>
    <script nonce="{{nonce}}" src="{{dagreUri}}"></script>
    <script nonce="{{nonce}}" src="{{cytoscapeDagreUri}}"></script>
    <!-- fCoSE dependencies (order matters) -->
    <script nonce="{{nonce}}" src="{{layoutBaseUri}}"></script>
    <script nonce="{{nonce}}" src="{{coseBaseUri}}"></script>
    <script nonce="{{nonce}}" src="{{cytoscapeFcoseUri}}"></script>
    <!-- Expand-collapse extension for zoom-based LOD -->
    <script nonce="{{nonce}}" src="{{cytoscapeExpandCollapseUri}}"></script>
    <script nonce="{{nonce}}" src="{{mainScriptUri}}"></script>
</body>
</html>
